<div class="devise-page">
  <div class="d-flex">
    <!-- Menú lateral fijo -->
    <aside class="bg-white p-4 border-end" style="width: 220px; min-height: 0vh; position: fixed; top: 64px; left: 0; z-index: 100;">
      <h2 class="mb-4 fw-bold" style="color: #5BA2B9;">Menu</h2>
      <ul class="list-unstyled">
        <li class="mb-3"><%= link_to "Home", root_path, class: "fw-bold text-decoration-none", style: "color: #4b9857;" %></li>
        <li class="mb-3"><%= link_to "Messages", messages_path, class: "fw-bold text-decoration-none", style: "color: #4b9857; letter-spacing: 1px;" %></li>
        <li class="mb-3"><%= link_to "Schedules", schedules_path, class: "fw-bold text-decoration-none", style: "color: #4b9857; letter-spacing: 1px;" %></li>
        <li class="mb-3"><%= link_to "Appointments", appointments_path, class: "fw-bold text-decoration-none", style: "color: #4b9857; letter-spacing: 1px;" %></li>
        <li class="mb-3"><%= link_to "Requests", requests_path, class: "fw-bold text-decoration-none", style: "color: #4b9857; letter-spacing: 1px;" %></li>
      </ul>
    </aside>

    <!-- Contenido Principal -->
    <div class="col-md-10 p-4 bg-light">
      <!-- Métricas -->
      <div class="row text-center mb-4">
        <div class="col-md-4 mb-3">
          <div class="card border-0 shadow-sm p-3">
            <h6 class="text-muted">Total Pacientes</h6>
            <h3 class="text-success fw-bold"><%= @total_patients %></h3>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card border-0 shadow-sm p-3">
            <h6 class="text-muted">Pacientes Hoy</h6>
            <h3 class="text-success fw-bold"><%= @today_patients %></h3>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card border-0 shadow-sm p-3">
            <h6 class="text-muted">Fecha</h6>
            <h5 class="text-primary"><%= Date.today.strftime("%d %b %Y") %></h5>
          </div>
        </div>
      </div>

      <!-- Citas de Hoy (Parte corregida) -->
      <div class="row mb-4">
        <div class="col-md-4 mb-3">
          <div class="card border-0 shadow-sm p-3">
            <h6 class="fw-semibold text-muted">Citas Hoy</h6>
            <ul class="list-unstyled small mb-0">
              <% (@today_appointments || []).each do |appointment| %>
                <li class="d-flex justify-content-between py-1 border-bottom">
                  <span><strong><%= appointment[:patient_name] %></strong></span>
                  <span class="badge bg-light text-dark border"><%= appointment[:time] %></span>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Citas de hoy -->
  <div class="col-md-6">
    <div class="card signup-container p-3">
      <h6 class="fw-semibold text-muted">Today's Appointments</h6>
      <% if @today_appointments.any? %>
        <ul class="list-unstyled small mb-0">
          <% @today_appointments.each do |appt| %>
            <li class="d-flex justify-content-between py-2 border-bottom">
              <strong><%= appt[:patient_name] %></strong>
              <span class="badge bg-light text-dark border"><%= appt[:time] %></span>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-muted">No appointments for today.</p>
      <% end %>
    </div>
  </div>

  <!-- Top pacientes -->
  <div class="col-md-6">
    <div class="card signup-container p-3">
      <h6 class="fw-semibold text-muted">Top Active Patients</h6>
      <ul class="list-group list-group-flush">
        <% @top_patients.each do |patient| %>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
              <% if patient.avatar.attached? %>
                <%= cl_image_tag patient.avatar.key, class: "rounded-circle", style: "object-fit: cover; width: 40px; height: 40px;" %>
              <% else %>
                <%= image_tag "default-avatar.png", class: "rounded-circle", style: "width: 40px; height: 40px;" %>
              <% end %>
              <strong><%= "#{patient.first_name} #{patient.last_name}" %></strong>
            </div>
            <span class="badge bg-success rounded-pill"><%= patient.appointments_count %> appointments</span>
          </li>
        <% end %>


      </ul>
    </div>
  </div>


  <!-- Citas en 7 días -->
  <div class="col-md-6">
    <div class="card signup-container p-3">
      <h6 class="fw-semibold text-muted">Appointments in Last 7 Days</h6>
      <%= line_chart @appointments_per_day, height: "150px", library: { colors: ["#4b9857"] } %>

    </div>
  </div>

  <!-- Estado de solicitudes -->
  <div class="col-md-6">
    <div class="card signup-container p-3">
      <h6 class="fw-semibold text-muted">Therapy Requests by Status</h6>
      <%= pie_chart @therapy_request_statuses, height: "150px", library: { colors: ["#ffc107", "#28a745", "#dc3545", "#6c757d"] } %>
    </div>
  </div>

  <!-- Día más activo -->
  <div class="col-md-6">
    <div class="card signup-container p-3">
      <h6 class="fw-semibold text-muted">Busiest Day</h6>
      <p class="fs-5 text-primary fw-bold mb-0">
        <%= @busiest_day.strftime("%A, %d %b %Y") if @busiest_day %>
      </p>
    </div>
  </div>

</div>

      </section>
    </div>
  </div>
</div>
